<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CB360_OCORR√äNCIAS</title>
  <style>
    /* ==================== BODY ==================== */
    * {margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent !important; -webkit-touch-callout: none !important;}
    body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); min-height: 100vh; user-select: none;
          transition: all 0.3s ease; display: flex; flex-direction: column; height: 100vh; overflow: hidden;}
    /* ============= DARK MODE OPTIONS ============== */
    .dark-mode {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #fff;}
    .dark-mode .main-content {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);}
    .dark-mode .epe-container {background: rgba(45, 45, 45, 0.95); border: 1px solid #444;}
    .dark-mode .epe-container h1 {color: #fff;}
    .dark-mode .epe-title {color: #fff;}
    .dark-mode .occurrences-container {background: rgba(45, 45, 45, 0.95); border: 1px solid #444;}
    .dark-mode .occurrences-container h1 {color: #fff;}
    .dark-mode .table-container {background: rgba(45, 45, 45, 0.95); border: 1px solid #444;}
    .dark-mode table {background: transparent;}
    .dark-mode th {background: linear-gradient(45deg, #d32f2f, #b71c1c);}
    .dark-mode td {color: #fff; border-color: #555;}
    .dark-mode tr:nth-child(even) {background: rgba(255, 255, 255, 0.05);}
    .dark-mode tr:hover {background: rgba(255, 255, 255, 0.1);}
    .dark-mode .popup-content {background: #2d2d2d; color: #fff;}
    .dark-mode .popup-content h2 {color: #fff;}
    .dark-mode .occurrence-info {background: rgba(255, 255, 255, 0.05); border-color: #555;}
    .dark-mode .occurrence-info strong {color: #3498db;}
    .dark-mode textarea {background: #3a3a3a; border-color: #555; color: #fff;}
    .dark-mode .attachment-preview {background: rgba(255, 255, 255, 0.05); border-color: #555;}
    .dark-mode .attachment-item {background: rgba(255, 255, 255, 0.1);}
    /* ============= LIGHT MODE OPTIONS ============= */
    .header {background: linear-gradient(45deg, #d32f2f, #b71c1c); color: white; padding: 20px 15px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); border-bottom: 2px solid #c62828;
             transition: all 0.3s ease; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;}
    .header h1, .header h2 {margin: 0; font-size: 1.5em; font-weight: bold;}
    .header div {margin-top: 5px; font-size: 12px; opacity: 0.9;}
    .header-logo {position: absolute; left: 10px; top: 50%; transform: translateY(-50%); height: 80px; width: auto; border-radius: 8px; transition: all 0.3s ease; z-index: 1001;}
    .footer {background: linear-gradient(45deg, #d32f2f, #b71c1c); color: white; padding: 8px 15px; text-align: center; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3); border-top: 2px solid #c62828;
             transition: all 0.3s ease; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;}
    .footer-content {max-width: 400px; margin: 0 auto;}
    .powered-by {font-size: 13px; font-weight: bold; margin-bottom: 3px; color: #fff}
    .footer-year {font-size: 10px; opacity: 0.8; color: #ffcdd2;}
    .footer strong {color: #ffebee;}
    .main-content {flex: 1; overflow-y: auto; padding-top: 95px; padding-bottom: 80px; padding-left: 20px; padding-right: 20px;}
    .main-content::-webkit-scrollbar {width: 6px;}
    .main-content::-webkit-scrollbar-track {background: rgba(0, 0, 0, 0.1); border-radius: 10px;}
    .main-content::-webkit-scrollbar-thumb {background: linear-gradient(45deg, #d32f2f, #b71c1c); border-radius: 10px;}
    .main-content::-webkit-scrollbar-thumb:hover {background: linear-gradient(45deg, #c62828, #a00000);}    
    .epe-container {background: rgba(255, 255, 255, 0.95); margin: 20px 0; padding: 5px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
                    animation: fadeIn 0.5s ease-out;}
    .epe-container h1 {color: #2c3e50; margin-bottom: 20px; text-align: center; font-size: 1.8em;}
    .epe-container h1::after {content: ""; display: block; height: 1px; background: rgba(255, 255, 255, 0.2); margin: 15px auto; width: 95%;}
    .message {text-align: center; padding: 10px 15px; margin: 10px auto; border-radius: 5px; font-weight: bold; animation: fadeIn 0.5s ease-out; font-size: 20px; max-width: 300px; width: fit-content;}
    .epe-level-0 {background-color: #459640; color: white;} .epe-level-1 {background-color: #3498db; color: white;} .epe-level-2 {background-color: #f1c40f; color: black;}
    .epe-level-3 {background-color: #e67e22; color: black;} .epe-level-4 {background-color: #e74c3c; color: white;}
    .epe-title {text-align: center; font-size: 15px; font-weight: bold; color: #2c3e50; margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 1px;}
    .occurrences-container {background: rgba(255, 255, 255, 0.95); margin: 20px 0; padding: 20px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
                            animation: fadeIn 0.5s ease-out;}
    .occurrences-container h1 {color: #2c3e50; margin-bottom: 20px; text-align: center; font-size: 1.8em;}
    .occurrences-container h1::after {content: ""; display: block; height: 1px; background: rgba(255, 255, 255, 0.2); margin: 15px auto; width: 95%;}
    .no-occurrences {text-align: center; padding: 20px 15px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 5px; font-size: 1.0em; font-weight: bold; width: 350px;
                     height: 40px; margin: 10px auto; box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3); animation: fadeIn 0.5s ease-out; line-height: 40px; padding:0;}
    .table-container {display: none; background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;}
    table {width: 100%; border-collapse: collapse; background: transparent;}
    th {background: linear-gradient(45deg, #d32f78, #b71c1c); color: white; padding: 15px 12px; text-align: center; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;}
    td {padding: 15px 12px; text-align: center; border-bottom: 1px solid #ecf0f1; font-size: 14px; color: #2c3e50; transition: all 0.3s ease;}
    tr:nth-child(even) {background: #f8f9fa;}
    tr:hover {background: #e8f4f8; cursor: pointer;}
    .message.loading {background: linear-gradient(45deg, #3498db, #2980b9); color: white;}
    .message.error {background: linear-gradient(45deg, #e74c3c, #c0392b); color: white;}
    .message.empty {background: linear-gradient(45deg, #95a5a6, #7f8c8d); color: white;}
    
    /* ==================== POPUP STYLES ==================== */
    .popup-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999;
                    animation: fadeIn 0.3s ease-out;}
    .popup-overlay.active {display: flex;}
    .popup-content {background: white; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease-out; position: relative;}
    .popup-content::-webkit-scrollbar {width: 6px;}
    .popup-content::-webkit-scrollbar-track {background: rgba(0, 0, 0, 0.1); border-radius: 10px;}
    .popup-content::-webkit-scrollbar-thumb {background: linear-gradient(45deg, #d32f2f, #b71c1c); border-radius: 10px;}
    .popup-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;}
    .popup-header h2 {color: #2c3e50; font-size: 1.5em; margin: 0;}
    .close-btn {background: #e74c3c; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 20px; cursor: pointer; transition: all 0.3s ease;
                display: flex; align-items: center; justify-content: center;}
    .close-btn:hover {background: #c0392b; transform: rotate(90deg);}
    .occurrence-info {background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3498db;}
    .occurrence-info p {margin: 8px 0; font-size: 14px; color: #2c3e50;}
    .occurrence-info strong {color: #e74c3c;}
    textarea {width: 100%; min-height: 120px; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; margin-bottom: 15px;
              transition: all 0.3s ease;}
    textarea:focus {border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);}
    .attachment-section {margin-bottom: 15px;}
    .attachment-label {display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50;}
    .attachment-btn {background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;
                     display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; width: 100%; justify-content: center;}
    .attachment-btn:hover {background: linear-gradient(45deg, #2980b9, #21618c); transform: translateY(-2px);}
    .attachment-btn:active {transform: translateY(0);}
    .attachment-preview {margin-top: 10px; padding: 10px; background: #f8f9fa; border: 2px dashed #bdc3c7; border-radius: 8px; display: none;}
    .attachment-preview.has-files {display: block;}
    .attachment-item {display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; margin-bottom: 8px;}
    .attachment-item:last-child {margin-bottom: 0;}
    .attachment-info {display: flex; align-items: center; gap: 8px; flex: 1;}
    .attachment-icon {font-size: 20px;}
    .attachment-name {font-size: 13px; color: #2c3e50; font-weight: 500;}
    .remove-attachment {background: #e74c3c; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 16px; display: flex;
                        align-items: center; justify-content: center; transition: all 0.3s ease;}
    .remove-attachment:hover {background: #c0392b; transform: scale(1.1);}
    .popup-actions {display: flex; gap: 10px; margin-top: 20px;}
    .send-btn {flex: 1; background: linear-gradient(45deg, #27ae60, #229954); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 16px;
               cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;}
    .send-btn:hover {background: linear-gradient(45deg, #229954, #1e8449); transform: translateY(-2px);}
    .send-btn:active {transform: translateY(0);}
    .send-btn:disabled {opacity: 0.5; cursor: not-allowed;}
    .cancel-btn {flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 16px;
                 cursor: pointer; transition: all 0.3s ease;}
    .cancel-btn:hover {background: linear-gradient(45deg, #7f8c8d, #6c7a7d);}
    
    @keyframes fadeIn {from {opacity: 0;} to {opacity: 1;}}
    @keyframes slideUp {from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;}}
    
    /* ============ RESPONSIVENESS 480px ============ */
    @media (max-width: 480px) {
      .popup-content {padding: 20px; max-width: 95%; max-height: 90vh;}
      .popup-header h2 {font-size: 1.2em;}
      textarea {min-height: 100px;}
      .send-btn, .cancel-btn {padding: 12px; font-size: 14px;}
      .header {padding: 8px 15px;}
      .header h1, .header h2 {font-size: 1.3em !important;}
      .header-logo {height: 50px; top: 32px;}
      .footer {padding: 5px 15px;}
      .powered-by {font-size: 11px;}
      .footer-year {font-size: 9px;}
    }
  </style>
</head>
<body>
  <header class="header">
    <img id="corpLogo" class="header-logo" alt="Logo" src="">
    <h1>GEST√ÉO DE OCORR√äNCIAS</h1>
    <h2 id="corpInfo" style="display: none;"></h2>
    <div>Sistema de Visualiza√ß√£o de Ocorr√™ncias</div>
  </header>
  
  <div class="main-content">
    <div class="epe-container">
      <h1>‚ö†Ô∏è Estados de Prontid√£o Especial ‚ö†Ô∏è</h1>
      <div class="epe-title">EPE DECIR</div>
      <div id="epedecir" class="message loading">Carregando...</div>
      <div class="epe-title">EPE DIOPS</div>
      <div id="epediops" class="message loading">Carregando...</div>
    </div>
    
    <div class="occurrences-container">
      <h1>üî• Ocorr√™ncias em Curso üî•</h1>
      <div id="messageContainer"></div>
      <div class="table-container">
        <table id="ocorrenciasTable" style="display:none">
          <thead>
            <tr>
              <th>Ocorr√™ncia</th>
              <th>Local</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="noOccurrencesMessage" class="no-occurrences" style="display: none;">
        ‚úÖ N√£o Existem Ocorr√™ncias em Curso
      </div>
    </div>
  </div>
  
  <!-- POPUP DE OCORR√äNCIA -->
  <div id="occurrencePopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2>üìã Detalhes da Ocorr√™ncia</h2>
        <button class="close-btn" onclick="closeOccurrencePopup()">√ó</button>
      </div>
      
      <div class="occurrence-info" id="occurrenceDetails">
        <p><strong>Ocorr√™ncia:</strong> <span id="detailOccurrence">-</span></p>
        <p><strong>Local:</strong> <span id="detailLocal">-</span></p>
        <p><strong>Estado:</strong> <span id="detailStatus">-</span></p>
      </div>
      
      <div class="attachment-section">
        <label class="attachment-label">üìù Mensagem:</label>
        <textarea id="messageText" placeholder="Escreva aqui informa√ß√µes adicionais sobre a ocorr√™ncia..."></textarea>
      </div>
      
      <div class="attachment-section">
        <label class="attachment-label">üìé Anexos: <span style="font-size: 12px; color: #7f8c8d;">(Clique v√°rias vezes para adicionar mais fotos)</span></label>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        <button class="attachment-btn" onclick="document.getElementById('fileInput').click()">
          <span>üìé</span>
          <span>Adicionar Foto (<span id="photoCount">0</span>/10)</span>
        </button>
        <div id="attachmentPreview" class="attachment-preview"></div>
      </div>
      
      <div class="popup-actions">
        <button class="cancel-btn" onclick="closeOccurrencePopup()">‚ùå Cancelar</button>
        <button class="send-btn" onclick="sendOccurrenceReport()">
          <span>üì§</span>
          <span>Enviar Relat√≥rio</span>
        </button>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <div class="footer-content">
      <div class="powered-by">
        <strong>Powered by:</strong> F√°bio Martins | Sistemas de Informa√ß√£o - Grupo CB360
      </div>
      <div class="footer-year">
        ¬© 2023-2025 - Sistema CB360 Mobile
      </div>
    </div>
  </div>
  
  <script>
    const SUPABASE_URL = 'https://rjkbodfqsvckvnhjwmhg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqa2JvZGZxc3Zja3ZuaGp3bWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNjM3NjQsImV4cCI6MjA2MzczOTc2NH0.jX5OPZkz1JSSwrahCoFzqGYw8tYkgE8isbn12uP43-0';
    const TELEGRAM_API = 'https://cb360-online.vercel.app/api/mobile/sendTelegram';
    
    let selectedFiles = [];
    let currentOccurrence = null;
    
    function getSupabaseHeaders(options = {}) {
      const headers = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json'
      };
      if (options.returnRepresentation) headers['Prefer'] = 'return=representation';
      return headers;
    }
    
    async function loadCorpInfo() {
      const corpOperNr = localStorage.getItem("currentCorpOperNr");
      const h2 = document.getElementById("corpInfo");
      const logoEl = document.getElementById("corpLogo");
      if (!corpOperNr) {
        if (h2) h2.textContent = "N√£o definido";
        return;
      }
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/corporation_data?select=corporation,corp_oper_nr,logo_url&corp_oper_nr=eq.${corpOperNr}`,
          { headers: getSupabaseHeaders() }
        );
        const data = await response.json();
        if (data && data.length > 0) {
          const corp = data[0];
          if (h2) h2.textContent = corp.corp_oper_nr || "N/D";
          if (logoEl && corp.logo_url) logoEl.src = corp.logo_url.trim();
        }
      } catch (err) {
        console.error('Erro no loadCorpInfo:', err);
      }
    }
    
    let controllerEpe, controllerOcorrencias;
    
    async function LoadEPE() {
      if (controllerEpe) controllerEpe.abort();
      controllerEpe = new AbortController();
      try {
        const response = await fetch('https://cb360-online.vercel.app/api/mobile/occurrences_control', {
          signal: controllerEpe.signal
        });
        const result = await response.json();
        const epeDecirStatus = document.getElementById('epedecir');
        const epeDiopsStatus = document.getElementById('epediops');
        epeDecirStatus.className = 'message';
        epeDiopsStatus.className = 'message';
        
        if (result.success && Array.isArray(result.epeData) && result.epeData.length > 0) {
          const epeDecir = result.epeData.find(item => item.epe_type === 'epe-decir');
          if (epeDecir) {
            const epeNivel = epeDecir.epe;
            epeDecirStatus.textContent = epeNivel;
            const levelMap = {
              'Monitoriza√ß√£o': 'epe-level-0', 'MONITORIZA√á√ÉO': 'epe-level-0',
              'N√≠vel I': 'epe-level-1', 'N√çVEL I': 'epe-level-1',
              'N√≠vel II': 'epe-level-2', 'N√çVEL II': 'epe-level-2',
              'N√≠vel III': 'epe-level-3', 'N√çVEL III': 'epe-level-3',
              'N√≠vel IV': 'epe-level-4', 'N√çVEL IV': 'epe-level-4'
            };
            epeDecirStatus.classList.add(levelMap[epeNivel] || 'empty');
          } else {
            epeDecirStatus.textContent = 'EPE-DECIR n√£o encontrado';
            epeDecirStatus.classList.add('empty');
          }
          
          const epeDiops = result.epeData.find(item => item.epe_type === 'epe-diops');
          if (epeDiops) {
            const epeNivelDiops = epeDiops.epe;
            epeDiopsStatus.textContent = epeNivelDiops;
            const levelMap = {
              'Monitoriza√ß√£o': 'epe-level-0', 'MONITORIZA√á√ÉO': 'epe-level-0',
              'N√≠vel I': 'epe-level-1', 'N√çVEL I': 'epe-level-1',
              'N√≠vel II': 'epe-level-2', 'N√çVEL II': 'epe-level-2',
              'N√≠vel III': 'epe-level-3', 'N√çVEL III': 'epe-level-3',
              'N√≠vel IV': 'epe-level-4', 'N√çVEL IV': 'epe-level-4'
            };
            epeDiopsStatus.classList.add(levelMap[epeNivelDiops] || 'empty');
          } else {
            epeDiopsStatus.textContent = 'EPE-DIOPS n√£o encontrado';
            epeDiopsStatus.classList.add('empty');
          }
        } else {
          epeDecirStatus.textContent = 'Sem dados do EPE';
          epeDecirStatus.classList.add('empty');
          epeDiopsStatus.textContent = 'Sem dados do EPE';
          epeDiopsStatus.classList.add('empty');
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Erro ao carregar EPE:', error);
        }
      }
    }
    
    async function LoadOccurrences() {
      if (controllerOcorrencias) controllerOcorrencias.abort();
      controllerOcorrencias = new AbortController();
      try {
        const response = await fetch('https://cb360-online.vercel.app/api/mobile/occurrences_control', {
          signal: controllerOcorrencias.signal
        });
        const result = await response.json();
        if (!result.success) return;
        
        const tabela = document.getElementById('ocorrenciasTable');
        const tableContainer = document.querySelector('.table-container');
        const tbody = tabela.querySelector('tbody');
        const noMsg = document.getElementById('noOccurrencesMessage');
        
        tableContainer.style.display = 'none';
        noMsg.style.display = 'none';
        tbody.innerHTML = '';
        
        if (!result.ocorrencias || result.ocorrencias.length === 0) {
          noMsg.style.display = 'block';
          return;
        }
        
        tableContainer.style.display = 'block';
        tabela.style.display = 'table';
        
        result.ocorrencias.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Ocorr√™ncia">${item.occorrence}</td>
            <td data-label="Local">${item.local}</td>
            <td data-label="Estado">${item.status}</td>
          `;
          tr.onclick = () => openOccurrencePopup(item);
          tbody.appendChild(tr);
        });
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Erro ao carregar ocorr√™ncias:', error);
        }
      }
    }
    
    function openOccurrencePopup(occurrence) {
      currentOccurrence = occurrence;
      document.getElementById('detailOccurrence').textContent = occurrence.occorrence;
      document.getElementById('detailLocal').textContent = occurrence.local;
      document.getElementById('detailStatus').textContent = occurrence.status;
      document.getElementById('messageText').value = '';
      selectedFiles = [];
      updateAttachmentPreview();
      document.getElementById('occurrencePopup').classList.add('active');
    }
    
    function closeOccurrencePopup() {
      document.getElementById('occurrencePopup').classList.remove('active');
      currentOccurrence = null;
      selectedFiles = [];
      updateAttachmentPreview();
    }
    
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      selectedFiles = [...selectedFiles, ...files];
      if (selectedFiles.length > 10) {
        alert('‚ö†Ô∏è M√°ximo de 10 fotos permitidas!');
        selectedFiles = selectedFiles.slice(0, 10);
      }
      updateAttachmentPreview();
      event.target.value = '';
    }
    
    function updateAttachmentPreview() {
      const preview = document.getElementById('attachmentPreview');
      const counter = document.getElementById('photoCount');
      if (counter) counter.textContent = selectedFiles.length;
      if (selectedFiles.length === 0) {
        preview.classList.remove('has-files');
        preview.innerHTML = '';
        return;
      }
      preview.classList.add('has-files');
      preview.innerHTML = selectedFiles.map((file, index) => `
        <div class="attachment-item">
          <div class="attachment-info">
            <span class="attachment-icon">üì∑</span>
            <span class="attachment-name">${file.name}</span>
          </div>
          <button class="remove-attachment" onclick="removeAttachment(${index})">√ó</button>
        </div>
      `).join('');
    }
    
    function removeAttachment(index) {
      selectedFiles.splice(index, 1);
      updateAttachmentPreview();
    }
    
    async function sendOccurrenceReport() {
      if (!currentOccurrence) return;
      const messageText = document.getElementById('messageText').value.trim();
      if (!messageText && selectedFiles.length === 0) {
        alert('‚ùå Escreva uma mensagem ou adicione anexos!');
        return;
      }
      const now = new Date();
      const time = now.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
      const date = now.toLocaleDateString('pt-PT');
      let message = `üö® <b>RELAT√ìRIO DE OCORR√äNCIA</b>\n\n`;
      message += `üìã <b>Ocorr√™ncia:</b> ${currentOccurrence.occorrence}\n`;
      message += `üìç <b>Local:</b> ${currentOccurrence.local}\n`;
      message += `üìä <b>Estado:</b> ${currentOccurrence.status}\n`;
      message += `‚è∞ ${time}\n`;
      message += `üìÖ ${date}`;
      if (messageText) {
        message += `\n\nüí¨ <b>Mensagem:</b>\n${messageText}`;
      }
      const sendBtn = document.querySelector('.send-btn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span>‚è≥</span><span>Enviando...</span>';
      try {
        if (selectedFiles.length === 0) {
          const res = await fetch(TELEGRAM_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, photo: null })
          });
          if (res.ok) {
            alert('‚úÖ Relat√≥rio enviado com sucesso!');
            closeOccurrencePopup();
          } else {
            throw new Error('Erro ao enviar');
          }
        } else {
          await fetch(TELEGRAM_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, photo: null })
          });
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const base64 = await fileToBase64(file);
            await fetch(TELEGRAM_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                message: `üìé Anexo ${i + 1}/${selectedFiles.length}`,
                photo: base64
              })
            });
          }
          alert('‚úÖ Relat√≥rio e anexos enviados com sucesso!');
          closeOccurrencePopup();
        }
      } catch (err) {
        console.error('‚ùå Erro ao enviar:', err);
        alert('‚ùå Erro ao enviar relat√≥rio!');
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<span>üì§</span><span>Enviar Relat√≥rio</span>';
      }
    }
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    window.addEventListener('load', function() {
      const savedTheme = localStorage.getItem('sgo-theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
      }
      loadCorpInfo();
      LoadEPE();
      LoadOccurrences();
      setInterval(LoadEPE, 2000);
      setInterval(LoadOccurrences, 2000);
    });
    
    document.getElementById('occurrencePopup').addEventListener('click', function(e) {
      if (e.target === this) {
        closeOccurrencePopup();
      }
    });
  </script>
</body>
</html>
